# This file is a template, and might need editing before it works on your project.
# Official docker image.
# Version 1.1
image: docker:latest
variables:
  DOCKER_HOST: tcp://localhost:2375


services:
  - docker:dind

stages:
  - build_service
  - deploy

build_autoit_portal:
  stage: build_autoit_portal
  script:
    - docker login -u gitlab-ci-token -p "$CI_BUILD_TOKEN" "$CI_REGISTRY"
    - docker build -t ${CI_REGISTRY_IMAGE}:latest -f application/Dockerfile application/
    - docker tag ${CI_REGISTRY_IMAGE}:latest ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA}
    - docker push ${CI_REGISTRY_IMAGE}:latest
    - docker push ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA}
  tags:
  - kubernetes
  only:
    refs:
      - master
    changes:
      - application/*

deploy_to_dev:
    stage: deploy
    image: alpine:3.7
    script:
        - apk update  && apk add --no-cache curl
        - curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
        - chmod +x ./kubectl && mv ./kubectl /usr/local/bin/kubectl
        - mkdir -p $HOME/.kube
        - echo -n ${kube_config} | base64 -d > $HOME/.kube/config
        - kubectl apply -f k8s/app.yml -n sevice
        - kubectl set image deployment/portal-lab portal-lab=${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA} -n sevice
        - kubectl apply -f k8s/svc.yml -n sevice
        - kubectl apply -f k8s/ingress.yml -n sevice
    tags:
        - kubernetes

    only:
      refs:
        - master
      changes:
        - application/*